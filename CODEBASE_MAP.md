# TeleMux Codebase Mapping - Complete Analysis

**Generated:** 2025-11-09
**Repository:** /Users/malmazan/dev/telemux
**Installation:** ~/.telemux
**Project Status:** Active development

---

## SECTION 1: Shell Function Locations

### 1.1 Primary Installation (Source)
**Location:** `/Users/malmazan/dev/telemux/INSTALL.sh`
**Lines:** 113-198

Functions defined:
- `tg_alert()` - Lines 125-144
- `tg_agent()` - Lines 147-175
- `tg_done()` - Lines 178-187
- Control aliases - Lines 190-196

**Current Message Format in INSTALL.sh:**
- `tg_alert`: `[!] <b>[${tmux_session}]</b> ${message}`
- `tg_agent`: `[>] <b>[${agent_name}:${msg_id}]</b>` with reply instructions
- Message ID source: `${tmux_session}` (tmux session name)

---

### 1.2 Deployed Installation (Active)
**Location:** `/Users/malmazan/.zshrc`
**Lines:** 218-303

**Block Structure:**
- Section header: Line 218 (`# TELEGRAM NOTIFICATIONS`)
- Config loading: Lines 221-224
- `tg_alert()` function: Lines 227-246
- `tg_agent()` function: Lines 249-277
- `tg_done()` function: Lines 280-289
- Backwards compatibility aliases: Lines 292-294
- Control command aliases: Lines 297-303

**Status:** DEPLOYED AND ACTIVE
**Last updated:** Via INSTALL.sh (lines appended)

---

### 1.3 README Documentation
**Location:** `/Users/malmazan/dev/telemux/README.md`
**Lines:** 119-187

Functions documented (code examples, not actual definitions):
- `tg_alert()` - Lines 119-135
- `tg_agent()` - Lines 138-166
- `tg_done()` - Lines 169-177
- Control aliases - Lines 181-186

**Status:** Documentation copy (matches INSTALL.sh exactly)

---

### 1.4 UPDATE Script
**Location:** `/Users/malmazan/dev/telemux/UPDATE.sh`
**Status:** NO FUNCTION DEFINITIONS HERE
**Role:** Updates binary files and check aliases only
**Alias updates:** Lines 77-132 (sed-based patching)

---

## SECTION 2: DRY Analysis - Function Duplication

### Current Duplicates

| Function | INSTALL.sh | README.md | .zshrc | Source of Truth |
|-----------|-----------|----------|--------|-----------------|
| `tg_alert()` | Lines 125-144 | Lines 119-135 | Lines 227-246 | INSTALL.sh |
| `tg_agent()` | Lines 147-175 | Lines 138-166 | Lines 249-277 | INSTALL.sh |
| `tg_done()` | Lines 178-187 | Lines 169-177 | Lines 280-289 | INSTALL.sh |

### Duplication Assessment

**Status:** MINOR DRY VIOLATIONS
- INSTALL.sh is source of truth
- README.md is documentation copy (expected)
- .zshrc is deployed version (generated by INSTALL.sh)
- Versions are currently identical ✓

**Risk Level:** LOW
- Manually maintained consistency works for current size
- Could become problematic if functions grow larger

---

## SECTION 3: telegram_listener.py Deep Dive

**Location (Source):** `/Users/malmazan/dev/telemux/telegram_listener.py`
**Location (Deployed):** `/Users/malmazan/.telemux/telegram_listener.py`
**Lines:** 1-401 (complete file)

### 3.1 Key Functions

#### `parse_message_id()` - Lines 207-220
```python
def parse_message_id(text: str) -> Optional[Tuple[str, str]]:
```
- **Regex Pattern:** `r'^([\w-]+):\s*(.+)$'`
- **Expected format:** `session-name: response text`
- **Returns:** Tuple of (message_id, response) or None
- **Current Issue:** Works with both old format (msg-timestamp) and new (session-name)

#### `lookup_agent()` - Lines 223-242
```python
def lookup_agent(message_id: str) -> Optional[Dict]:
```
- **Source:** Reads from `~/.telemux/message_queue/outgoing.log`
- **Format:** `msg_id:agent_name:tmux_session:timestamp`
- **Returns:** Dict with keys: `message_id`, `agent_name`, `tmux_session`, `timestamp`
- **Dependency:** Requires pre-registration in `outgoing.log`

#### `route_to_agent()` - Lines 245-315
```python
def route_to_agent(agent_info: Dict, response: str):
```
**Operations:**
1. Create inbox directory: `~/.telemux/agents/{agent_name}/inbox.txt` (Line 254-256)
2. Write response to inbox file (Lines 259-270)
3. Log to incoming.log (Lines 275-276)
4. Try to deliver to tmux session (Lines 279-311)
   - Get list of active sessions (Lines 281-284)
   - Format message: `[FROM USER via Telegram] {response}` (Line 290)
   - Send text with `tmux send-keys` (Lines 293-296)
   - **Critical:** Sleep 1 second before pressing Enter (Lines 298-302)
   - Reason: tmux needs buffer time for text input
5. Send confirmation to Telegram (Line 314)

#### `process_update()` - Lines 317-345
```python
def process_update(update: Dict):
```
**Current Flow:**
1. Extract message text (Lines 322-323)
2. Parse for session-name format (Line 329)
3. Lookup agent in outgoing.log (Line 338)
4. If not found: Send "Unknown message ID" error (Line 341)
5. If found: Route to agent (Line 345)

**LIMITATION:** Only processes messages from pre-registered agents

---

### 3.2 Configuration Loading

#### `load_telegram_config()` - Lines 73-98
- **Source file:** `~/.telemux/telegram_config`
- **Method:** Uses bash `source` command to extract env vars
- **Env vars:** `TELEMUX_TG_BOT_TOKEN`, `TELEMUX_TG_CHAT_ID`
- **Logging:** Info on success, error on failure

#### `load_state()` - Lines 101-106
- **File:** `~/.telemux/message_queue/listener_state.json`
- **Contents:** `{"last_update_id": 453122738}` (current)
- **Purpose:** Prevents reprocessing duplicate messages

---

### 3.3 Telegram API Calls

#### `get_telegram_updates()` - Lines 116-165
- **Endpoint:** `https://api.telegram.org/bot{BOT_TOKEN}/getUpdates`
- **Long-polling:** 30 second timeout
- **Retry:** 3 attempts with exponential backoff (2^n seconds)
- **Error handling:** Timeout, connection, request exceptions

#### `send_telegram_message()` - Lines 168-204
- **Endpoint:** `https://api.telegram.org/bot{BOT_TOKEN}/sendMessage`
- **Retry:** 3 attempts with exponential backoff
- **Parse mode:** HTML

---

### 3.4 Logging Configuration

**Log Files:**
- **Main log:** `~/.telemux/telegram_listener.log` (all levels)
- **Error log:** `~/.telemux/telegram_errors.log` (errors only)
- **Console:** Configurable via `TELEMUX_LOG_LEVEL` env var

**Handlers Setup:** Lines 46-70
- Main handler (DEBUG to file)
- Error handler (ERROR to file)
- Console handler (configurable level)

**Current State:**
- Main log: 13KB, 355 lines (as of 2025-11-09 21:41)
- Error log: 203 bytes (minimal errors)

---

## SECTION 4: Control Scripts Location

**Primary Location:** `/Users/malmazan/dev/telemux/telegram_control.sh`
**Deployed Location:** `/Users/malmazan/.telemux/telegram_control.sh`
**Lines:** 1-256

### 4.1 Shell Aliases (Deployed)

**Location:** `/Users/malmazan/.zshrc` Lines 297-303

```bash
alias tg-start="$HOME/.telemux/telegram_control.sh start"
alias tg-stop="$HOME/.telemux/telegram_control.sh stop"
alias tg-status="$HOME/.telemux/telegram_control.sh status"
alias tg-logs="$HOME/.telemux/telegram_control.sh logs"
alias tg-restart="$HOME/.telemux/telegram_control.sh restart"
alias tg-cleanup="$HOME/.telemux/telegram_control.sh cleanup"
alias tg-doctor="$HOME/.telemux/telegram_control.sh doctor"
```

### 4.2 Control Script Commands

| Command | Lines | Purpose |
|---------|-------|---------|
| `start` | 10-35 | Create tmux session, run python daemon |
| `stop` | 37-46 | Kill telegram-listener session |
| `restart` | 48-52 | Stop then start |
| `status` | 54-66 | Check if running, show logs |
| `logs` | 68-74 | Tail -f the log file |
| `attach` | 76-83 | Attach to tmux session |
| `cleanup` | 85-92 | Call cleanup-logs.sh script |
| `doctor` | 94-235 | Health check (40+ lines) |

### 4.3 Doctor Command (Health Check)

**Lines:** 94-235
**Checks:**
1. tmux installed and version (Lines 100-106)
2. Python3 installed (Lines 110-116)
3. requests library (Lines 120-126)
4. Config file exists and permissions (Lines 131-170)
5. Bot connection test (Lines 174-190)
6. Listener process running (Lines 194-200)
7. Log files exist and sizes (Lines 204-228)

---

## SECTION 5: Configuration Files

### 5.1 Telegram Config File
**Location:** `/Users/malmazan/.telemux/telegram_config`
**Permissions:** 600 (owner read/write only)
**Status:** SECURE ✓

**Current Contents:**
```bash
#!/bin/bash
# TeleMux Telegram Bot Configuration
# Keep this file secure! (chmod 600)

export TELEMUX_TG_BOT_TOKEN="8355342651:AAE672Hf-saeSUkqvs1JrjjYN_fIy5hLPZs"
export TELEMUX_TG_CHAT_ID="-5080940034"  # Marco & Kollabor AI group
export TELEMUX_TG_PERSONAL_CHAT_ID="1048349666"  # Your personal DM
```

**Generated by:** INSTALL.sh (Lines 54-63)

---

### 5.2 Listener State File
**Location:** `/Users/malmazan/.telemux/message_queue/listener_state.json`
**Current Contents:**
```json
{
  "last_update_id": 453122738
}
```

**Updated by:** telegram_listener.py (Line 113)
**Purpose:** Prevent message reprocessing

---

## SECTION 6: Message Queue Structure

**Base Directory:** `~/.telemux/message_queue/`

### 6.1 Outgoing Log
**File:** `~/.telemux/message_queue/outgoing.log`
**Format:** `msg_id:agent_name:tmux_session:timestamp`
**Current entries:** 9 lines
**Last entry:** `team-mux-setup:telemux-demo:team-mux-setup:2025-11-09T19:12:15-07:00`

**Examples:**
```
msg-1762738539-29626:test-agent:claude-session:2025-11-09T18:35:39-07:00
msg-1762739355-50350:claude-agent:team-mux-setup:2025-11-09T18:49:15-07:00
team-mux-setup:claude-agent:team-mux-setup:2025-11-09T18:50:04-07:00
team-mux-setup:telemux-demo:team-mux-setup:2025-11-09T19:12:15-07:00
```

**Two Formats In Use:**
- Old: `msg-{timestamp}-{random}` (deprecated)
- New: `{session-name}` (current, per IMPLEMENTATION_PLAN.md)

### 6.2 Incoming Log
**File:** `~/.telemux/message_queue/incoming.log`
**Format:** `msg_id:agent_name:timestamp:response_text_preview`
**Current entries:** 10 lines
**Latest:** `team-mux-setup:claude-agent:2025-11-09T19:23:48.729778:testing`

---

## SECTION 7: Agent Inbox Structure

**Base Directory:** `~/.telemux/agents/`
**Pattern:** `~/.telemux/agents/{agent_name}/inbox.txt`

**Directory Permissions:** Created by route_to_agent() (Line 255)

**Current Agents:** NONE (not created yet in fresh installation)

**Inbox Entry Format:**
```
[{ISO_TIMESTAMP}] MESSAGE FROM USER
Message ID: {message_id}
---
{response_text}
---

```

**Example** (from deployment-approval.sh):
```bash
INBOX="$HOME/.telemux/agents/deploy-agent/inbox.txt"
REPLY=$(grep -v "^\[" "$INBOX" 2>/dev/null | grep -v "^---" | grep -v "^$" | tail -1)
```

---

## SECTION 8: Example Scripts

### 8.1 Deployment Approval
**Location:** `/Users/malmazan/dev/telemux/examples/deployment-approval.sh`
**Lines:** 1-70

**Flow:**
1. Get VERSION and ENVIRONMENT parameters (Lines 7-8)
2. Call `tg_agent "deploy-agent"` (Lines 16-22)
3. Poll inbox file for response (Lines 25-62)
4. Timeout after 300 seconds (Line 29)
5. Parse responses: "yes/approve/proceed/go" or "no/cancel/reject/stop" (Lines 37-58)

**Key Pattern:** Reads inbox.txt, parses last non-empty, non-metadata line

### 8.2 AI Agent Question
**Location:** `/Users/malmazan/dev/telemux/examples/ai-agent-question.sh`
**Lines:** 1-78

**Flow:**
1. Set AGENT_NAME = "cleanup-agent" (Line 5)
2. Clear old inbox (Line 37)
3. Call `tg_agent` with question (Line 32)
4. Loop and check inbox for response (Lines 40-74)
5. Parse response: "1/auto/merge" or "2/manual/flag" or "3/skip" (Lines 49-67)

### 8.3 Build Notification
**Location:** `/Users/malmazan/dev/telemux/examples/long-build-notify.sh`
**Lines:** 1-43

**Flow:**
1. Send `tg_alert` before build (Line 10)
2. Run build command (Line 14+)
3. Send `tg_alert` after completion (Lines 28-41)
4. Calculate duration (Lines 20-25)

**Pattern:** One-way notifications only (no reply needed)

---

## SECTION 9: Testing & Validation Infrastructure

### 9.1 Current Testing
**Status:** NO AUTOMATED TESTS EXIST
**Test Examples:** Only in README and documentation

### 9.2 Installation Validation

**INSTALL.sh Lines 203-217:**
```bash
# Test installation
echo "=== Testing Installation ==="
source ~/.telemux/telegram_config

echo "Testing Telegram bot connection..."
RESPONSE=$(curl -s "https://api.telegram.org/bot${TELEMUX_TG_BOT_TOKEN}/getMe")

if echo "$RESPONSE" | grep -q '"ok":true'; then
    BOT_NAME=$(echo "$RESPONSE" | grep -o '"first_name":"[^"]*"' | cut -d'"' -f4)
    echo "✅ Bot connection successful: $BOT_NAME"
else
    echo "❌ Bot connection failed. Please check your bot token."
    exit 1
fi
```

**Current Outcome:** PASSES ✓

---

## SECTION 10: Dependencies Diagram

```
USER'S TMUX SESSION
    │
    ├─→ Shell Functions (tg_alert, tg_agent, tg_done)
    │   Located: ~/.zshrc (Lines 227-289)
    │   Source: INSTALL.sh (Lines 125-187)
    │
    └─→ Shell Aliases (tg-start, tg-stop, etc.)
        Located: ~/.zshrc (Lines 297-303)
        Points to: ~/.telemux/telegram_control.sh

~/.telemux/telegram_config
    │
    ├─→ Source: INSTALL.sh (creates this)
    └─→ Loaded by: telegram_listener.py (Line 80)
    └─→ Loaded by: shell functions (Line 223 in .zshrc)

Telegram API
    │
    ├─→ Outgoing: Shell functions → curl → Telegram
    └─→ Incoming: telegram_listener.py ← long-polling ← Telegram

~/.telemux/message_queue/outgoing.log
    │
    ├─→ Written by: tg_agent() function (Line 264 in .zshrc)
    └─→ Read by: telegram_listener.py lookup_agent() (Line 229)

~/.telemux/agents/{agent_name}/inbox.txt
    │
    ├─→ Written by: telegram_listener.py route_to_agent() (Line 270)
    ├─→ Read by: Example scripts (deployment-approval.sh, ai-agent-question.sh)
    └─→ Delivered to tmux: telegram_listener.py send-keys (Lines 293-302)

telegram_listener.py
    │
    ├─→ Runs in: tmux session "telegram-listener"
    ├─→ Started by: telegram_control.sh start (Line 18)
    ├─→ Managed by: tg-start alias (from .zshrc Line 297)
    └─→ Logs to: ~/.telemux/telegram_listener.log
                 ~/.telemux/telegram_errors.log
```

---

## SECTION 11: Message Flow Sequence

### Outgoing Message (Agent → Telegram)

```
1. User runs: tg_agent "deploy-agent" "Deploy now?"
   Location: .zshrc Line 249-277

2. Function gets tmux session: $(tmux display-message -p '#S')
   Line 259

3. Uses session name as msg_id: msg_id="${tmux_session}"
   Line 260

4. Appends to outgoing.log:
   echo "${msg_id}:${agent_name}:${tmux_session}:$(date -Iseconds)" >> outgoing.log
   Line 264

5. Sends to Telegram via curl:
   POST /sendMessage with formatted text
   Lines 267-273

6. Returns msg_id to caller
   Line 276
```

### Incoming Message (Telegram → Agent)

```
1. Listener daemon polls Telegram (Line 371):
   get_telegram_updates(offset)

2. Parses message text (Line 329):
   parse_message_id("session-name: response")
   Pattern: r'^([\w-]+):\s*(.+)$'

3. Looks up agent in outgoing.log (Line 338):
   lookup_agent(message_id)
   Finds: {message_id, agent_name, tmux_session, timestamp}

4. Routes to agent (Line 345):
   route_to_agent(agent_info, response)

5. In route_to_agent():
   a. Create inbox dir (Line 254-256)
   b. Write to inbox.txt (Line 270)
   c. Log to incoming.log (Line 276)
   d. Get active tmux sessions (Line 281-284)
   e. If session exists:
      - Send text: tmux send-keys -t session "message" (Line 294)
      - Sleep 1 second (Line 299)
      - Press Enter: tmux send-keys -t session C-m (Line 301)
   f. Send confirmation to Telegram (Line 314)
```

---

## SECTION 12: Critical Dependencies

### External Tools
- **tmux** - Session management and send-keys
- **python3** - Telegram listener daemon
- **curl** - HTTP requests for Telegram API
- **bash/zsh** - Shell functions

### Python Libraries
- **requests** - HTTP library (installed via pip3)
- **pathlib** - Path handling (built-in)
- **json** - JSON parsing (built-in)
- **subprocess** - Process management (built-in)
- **re** - Regular expressions (built-in)

### Telegram Infrastructure
- **@BotFather** - Create/manage bot
- **Telegram Bot API** - Send/receive messages
- **Long-polling** - 30 second timeout

---

## SECTION 13: Current Issues & Limitations

### 1. DRY Violations
- Function definitions in INSTALL.sh duplicated in README.md
- No single source of truth for shell functions
- Manual consistency maintenance required

### 2. Message ID Confusion
- **Old format:** `msg-{timestamp}-{random}` (8 entries in outgoing.log)
- **New format:** `{session-name}` (1 new entry)
- **Status:** MIXED - both formats still in use
- **Impact:** lookup_agent() handles both, but confusing to users

### 3. Pre-Registration Requirement
- Messages can only be routed if pre-registered in outgoing.log via tg_agent()
- tg_alert() sends messages but they cannot receive replies
- **IMPLEMENTATION_PLAN.md** (Line 3) proposes removing this limitation

### 4. No Automated Tests
- Installation test exists (INSTALL.sh 203-217)
- No unit tests for python code
- No integration tests
- No test suite structure

### 5. Hardcoded Message Formats
- `tg_alert` prefix: `[!]` (INSTALL.sh Line 142)
- `tg_agent` prefix: `[>]` (INSTALL.sh Line 167)
- No configuration option for custom formats

### 6. Function Location Coupling
- Shell functions sourced from ~/.zshrc at shell startup
- Can't be easily updated without re-sourcing
- UPDATE.sh doesn't update function definitions (Lines 71-132)

---

## SECTION 14: Recommendations for DRY Refactoring

### Recommendation 1: Single Source of Truth
**Create:** `/Users/malmazan/dev/telemux/shell_functions.sh`
- Define all functions once
- Source it in INSTALL.sh instead of embedding
- Benefits: Single definition, reusable in UPDATE.sh

### Recommendation 2: Configuration Object
**Create:** `/Users/malmazan/dev/telemux/config_template.sh`
```bash
# Message prefixes (customizable)
TG_ALERT_PREFIX="[!]"
TG_AGENT_PREFIX="[>]"
TG_FROM_USER_PREFIX="[FROM USER via Telegram]"

# Endpoints
TG_API_BASE="https://api.telegram.org"
```

### Recommendation 3: Test Suite
**Create:** `/Users/malmazan/dev/telemux/tests/`
```
tests/
├── test_message_parsing.py
├── test_listener_routing.py
├── test_shell_functions.sh
├── test_integration.sh
└── fixtures/
    ├── sample_messages.json
    └── mock_sessions/
```

### Recommendation 4: Update Script Enhancement
**Enhance UPDATE.sh:**
- Add function definition update capability
- Compare versions before applying
- Include rollback mechanism

---

## SECTION 15: File Tree Summary

```
/Users/malmazan/dev/telemux/
├── INSTALL.sh                          (Shell functions SOURCE: 113-198)
├── UPDATE.sh                           (Alias updates: 71-132)
├── UNINSTALL.sh
├── MIGRATE.sh
├── telegram_listener.py                (Python daemon: 401 lines)
├── telegram_control.sh                 (Control script: 256 lines)
├── cleanup-logs.sh
├── README.md                           (Function docs: 119-187)
├── CLAUDE.md                           (Technical docs: 713 lines)
├── IMPLEMENTATION_PLAN.md              (Future simplification plan)
├── CHANGELOG.md
├── QUICKSTART.md
├── COMPATIBLE_LLMS.md
├── PROJECT_SUMMARY.txt
├── ROADMAP.md
├── REBRAND_SUMMARY.md
├── GENERIC_TEMPLATE.md
├── requirements.txt                    (requests library)
├── LICENSE
└── examples/
    ├── deployment-approval.sh          (Approval workflow)
    ├── ai-agent-question.sh            (Agent guidance)
    └── long-build-notify.sh            (Build notifications)

~/.telemux/
├── telegram_config                     (Credentials: 600 perms)
├── telegram_listener.py                (Deployed daemon)
├── telegram_control.sh                 (Deployed control)
├── telegram_listener.log               (13KB, 355 lines)
├── telegram_errors.log                 (203 bytes)
├── message_queue/
│   ├── outgoing.log                    (9 entries)
│   ├── incoming.log                    (10 entries)
│   └── listener_state.json             (offset tracking)
└── agents/                             (Created per-agent, currently empty)

~/.zshrc
├── TELEGRAM NOTIFICATIONS section      (Lines 218-303)
│   ├── Load config                    (222-224)
│   ├── tg_alert()                     (227-246)
│   ├── tg_agent()                     (249-277)
│   ├── tg_done()                      (280-289)
│   ├── Backwards compat aliases       (292-294)
│   └── Control aliases                (297-303)
```

---

## SECTION 16: Version & Status

**Current Installation:** v1.0.0 (per CLAUDE.md "v1.0.0 (2025-11-09)")
**Functions Last Deployed:** INSTALL.sh execution (timestamp: varies per installation)
**Listener Status:** RUNNING ✓ (tmux session: telegram-listener)
**Connection Status:** OPERATIONAL ✓ (Last update ID: 453122738)

---

## SECTION 17: Entry Points for Changes

### To add a new feature:
1. **Update telegram_listener.py** (source)
2. **Update INSTALL.sh** if changing shell functions or config
3. **Update README.md** to match INSTALL.sh
4. **Test with UPDATE.sh** to ensure smooth upgrades
5. **Verify telegraph_control.sh** aliases still work

### To fix a bug in shell functions:
1. Edit INSTALL.sh (Lines 125-187)
2. Run INSTALL.sh on test machine
3. Verify changes in ~/.zshrc
4. Update README.md to match
5. Commit changes

### To deploy to users:
1. Modify source files in `/Users/malmazan/dev/telemux/`
2. Test locally with INSTALL.sh and UPDATE.sh
3. Users run UPDATE.sh to get latest version
4. Verify with `tg-doctor`

---

**END OF CODEBASE MAP**
