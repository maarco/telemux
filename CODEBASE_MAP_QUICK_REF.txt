================================================================================
TELEMUX CODEBASE QUICK REFERENCE
================================================================================

FUNCTION LOCATIONS:
  tg_alert()     -> /Users/malmazan/dev/telemux/INSTALL.sh:125-144
  tg_agent()     -> /Users/malmazan/dev/telemux/INSTALL.sh:147-175
  tg_done()      -> /Users/malmazan/dev/telemux/INSTALL.sh:178-187
  [DEPLOYED]     -> /Users/malmazan/.zshrc:227-289

PYTHON DAEMON:
  parse_message_id()      -> telegram_listener.py:207-220
  lookup_agent()          -> telegram_listener.py:223-242
  route_to_agent()        -> telegram_listener.py:245-315
  process_update()        -> telegram_listener.py:317-345
  get_telegram_updates()  -> telegram_listener.py:116-165
  send_telegram_message() -> telegram_listener.py:168-204

CONTROL COMMANDS:
  tg-start   -> telegram_control.sh:10-35
  tg-stop    -> telegram_control.sh:37-46
  tg-restart -> telegram_control.sh:48-52
  tg-status  -> telegram_control.sh:54-66
  tg-logs    -> telegram_control.sh:68-74
  tg-doctor  -> telegram_control.sh:94-235

MESSAGE FLOW:
  OUTGOING:  User -> tg_agent() -> outgoing.log -> curl POST -> Telegram
  INCOMING:  Telegram -> listener poll -> parse_message_id() -> lookup_agent() 
             -> route_to_agent() -> inbox.txt + tmux send-keys

CONFIGURATION:
  Credentials:     ~/.telemux/telegram_config (600 perms)
  Listener state:  ~/.telemux/message_queue/listener_state.json
  Sent messages:   ~/.telemux/message_queue/outgoing.log
  Recv messages:   ~/.telemux/message_queue/incoming.log
  Agent inbox:     ~/.telemux/agents/{agent_name}/inbox.txt

EXAMPLE WORKFLOWS:
  Deployment:  /Users/malmazan/dev/telemux/examples/deployment-approval.sh
  Agent Q&A:   /Users/malmazan/dev/telemux/examples/ai-agent-question.sh
  Notify:      /Users/malmazan/dev/telemux/examples/long-build-notify.sh

DRY VIOLATIONS:
  - tg_alert/tg_agent/tg_done defined in INSTALL.sh and README.md (both identical)
  - No shell_functions.sh module (embedded in INSTALL.sh)
  - UPDATE.sh doesn't update function definitions

CRITICAL FINDINGS:
  1. Message ID formats mixed (old: msg-{ts}-{rand}, new: {session-name})
  2. No pre-registration -> no reply capability (tg_alert limitation)
  3. No automated test suite
  4. Hardcoded message prefixes ([!], [>], [FROM USER])
  5. UPDATE.sh coupling: doesn't update functions

MESSAGE ID FORMAT:
  outgoing.log: {msg_id}:{agent_name}:{tmux_session}:{timestamp}
  Regex parser: r'^([\w-]+):\s*(.+)$'

PARSING LOGIC:
  User sends: "session-name: response text"
  Parser extracts: ("session-name", "response text")
  Lookup finds: agent_name + tmux_session from outgoing.log
  Route delivers: to tmux session and to inbox file

CRITICAL CODE SNIPPET (route_to_agent):
  1. Create ~/.telemux/agents/{agent_name}/inbox.txt
  2. Write message to inbox
  3. Log to incoming.log
  4. Get active tmux sessions
  5. Send text: tmux send-keys -t session "message"
  6. Sleep 1 second (CRITICAL: tmux buffer time)
  7. Send Enter: tmux send-keys -t session C-m
  8. Confirm to Telegram

DEPLOYMENT FLOW:
  Source repo: /Users/malmazan/dev/telemux/
  Install cmd: ./INSTALL.sh (creates ~/.telemux/)
  Update cmd:  ./UPDATE.sh (upgrades existing install)
  Uninstall:   ./UNINSTALL.sh
  Migrate:     ./MIGRATE.sh (from old .team_mux)

FILES TO MONITOR:
  - INSTALL.sh (shell functions source)
  - README.md (must match INSTALL.sh)
  - telegram_listener.py (python daemon)
  - telegram_control.sh (control commands)
  - UPDATE.sh (upgrade script)
  - .zshrc (deployed functions)

TESTING:
  Installation test: INSTALL.sh:203-217
  Status check: tg-doctor (comprehensive health check)
  Manual test: tg_alert "test message"

ENTRY POINTS FOR CHANGES:
  New feature  -> Edit telegram_listener.py + INSTALL.sh + README.md
  Bug fix      -> INSTALL.sh + README.md match check + .zshrc update
  Deploy       -> Commit + UPDATE.sh propagation + tg-doctor verify

================================================================================
FULL ANALYSIS: See CODEBASE_MAP.md (695 lines, 17 sections)
================================================================================
